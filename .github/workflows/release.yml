name: Release Build

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g. 1.0.0 or v1.0.0)"
        required: true
  push:
    tags:
      - "v*"

jobs:
  release:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine version
        id: version
        shell: pwsh
        run: |
          $event = '${{ github.event_name }}'
          $inputVersion = '${{ github.event.inputs.version }}'
          if ($event -eq 'workflow_dispatch') {
              if ([string]::IsNullOrWhiteSpace($inputVersion)) {
                  throw "版本号不能为空。"
              }
              $versionText = $inputVersion
          }
          else {
              $versionText = '${{ github.ref_name }}'
          }

          if ([string]::IsNullOrWhiteSpace($versionText)) {
              throw "无法解析版本号。"
          }

          if ($versionText -like 'v*') {
              $tagName = $versionText
              $displayVersion = $versionText.TrimStart('v')
          }
          else {
              $tagName = "v$versionText"
              $displayVersion = $versionText
          }

          "tag=$tagName" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "version=$displayVersion" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Setup NuGet
        uses: nuget/setup-nuget@v1

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Restore packages
        run: nuget restore YTPlayer.sln

      - name: Build Release
        shell: pwsh
        run: |
          msbuild YTPlayer.sln `
            /t:Rebuild `
            /p:Configuration=Release `
            "/p:Platform=Any CPU" `
            /m

      - name: Package binaries with dependencies
        id: package
        shell: pwsh
        run: |
          $stageRoot = Join-Path $pwd "dist"
          $stageDir = Join-Path $stageRoot "YTPlayer"
          if (Test-Path $stageRoot) { Remove-Item $stageRoot -Recurse -Force }
          New-Item -ItemType Directory -Path $stageDir -Force | Out-Null

          $releaseCandidates = @(
              "bin\Release",
              "bin\AnyCPU\Release",
              "bin\x64\Release"
          ) | ForEach-Object { Join-Path $pwd $_ }

          $buildOutput = $releaseCandidates | Where-Object { Test-Path $_ } | Select-Object -First 1

          if (-not $buildOutput) {
              throw "找不到 Release 编译输出目录 (bin\\Release)。请检查 MSBuild 输出。"
          }

          Write-Host "Packaging binaries from $buildOutput"
          Copy-Item -Path (Join-Path $buildOutput '*') -Destination $stageDir -Recurse -Force

          $zipName = "YTPlayer-${{ steps.version.outputs.version }}.zip"
          $zipPath = Join-Path $pwd $zipName
          if (Test-Path $zipPath) { Remove-Item $zipPath -Force }
          Compress-Archive -Path (Join-Path $stageDir '*') -DestinationPath $zipPath -Force

          $zipRelativePath = "./$zipName"

          "zip_path=$zipRelativePath" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          target_commitish: ${{ github.sha }}
          name: YTPlayer v${{ steps.version.outputs.version }}
          files: ${{ steps.package.outputs.zip_path }}
          draft: false
          prerelease: false
          generate_release_notes: true

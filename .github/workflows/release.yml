name: Release Build

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g. 1.0.0 or v1.0.0)"
        required: true
  push:
    tags:
      - "v*"

jobs:
  release:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.102'

      - name: Determine version
        id: version
        shell: pwsh
        run: |
          $event = '${{ github.event_name }}'
          $inputVersion = '${{ github.event.inputs.version }}'
          if ($event -eq 'workflow_dispatch') {
              if ([string]::IsNullOrWhiteSpace($inputVersion)) {
                  throw "版本号不能为空。"
              }
              $versionText = $inputVersion
          }
          else {
              $versionText = '${{ github.ref_name }}'
          }

          if ([string]::IsNullOrWhiteSpace($versionText)) {
              throw "无法解析版本号。"
          }

          if ($versionText -like 'v*') {
              $tagName = $versionText
              $displayVersion = $versionText.TrimStart('v')
          }
          else {
              $tagName = "v$versionText"
              $displayVersion = $versionText
          }

          "tag=$tagName" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "version=$displayVersion" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Resolve release metadata from changelog
        id: changelog
        shell: pwsh
        run: |
          $changelogPath = Join-Path $pwd "changelog.md"
          if (-not (Test-Path $changelogPath)) {
              throw "未找到 changelog.md，无法生成 Release 标题和正文。"
          }

          $lines = Get-Content -Path $changelogPath -Encoding UTF8
          if (-not $lines -or $lines.Count -eq 0) {
              throw "changelog.md 为空，无法生成 Release 内容。"
          }

          $headingIndexes = @()
          for ($i = 0; $i -lt $lines.Count; $i++) {
              if ($lines[$i] -match '^\s*#\s+(.+?)\s*$') {
                  $headingIndexes += $i
              }
          }

          if ($headingIndexes.Count -eq 0) {
              throw "changelog.md 未找到标题（以 # 开头）。"
          }

          $firstHeadingIndex = $headingIndexes[0]
          if ($lines[$firstHeadingIndex] -notmatch '^\s*#\s+(.+?)\s*$') {
              throw "无法解析 changelog.md 的第一个标题。"
          }

          $sectionTitle = $Matches[1].Trim()
          if ([string]::IsNullOrWhiteSpace($sectionTitle)) {
              throw "changelog.md 的第一个标题为空。"
          }

          $secondHeadingIndex = if ($headingIndexes.Count -ge 2) { $headingIndexes[1] } else { $lines.Count }
          $bodyLines = @()
          if ($secondHeadingIndex -gt ($firstHeadingIndex + 1)) {
              $bodyLines = $lines[($firstHeadingIndex + 1)..($secondHeadingIndex - 1)]
          }

          $sectionBody = ($bodyLines -join "`n").Trim()
          if ([string]::IsNullOrWhiteSpace($sectionBody)) {
              $sectionBody = "- 无更新说明。"
          }

          $releaseName = "YTPlayer v${{ steps.version.outputs.version }} - $sectionTitle"

          "title=$sectionTitle" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "release_name=$releaseName" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "body<<EOF" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          $sectionBody | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "EOF" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Setup NuGet
        uses: nuget/setup-nuget@v1

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2
        with:
          msbuild-architecture: x64

      - name: Restore packages
        run: nuget restore YTPlayer.sln

      - name: Build Release
        shell: pwsh
        run: |
          msbuild YTPlayer.sln `
            /t:Rebuild `
            /p:Configuration=Release `
            /p:Platform="x64" `
            /m

      - name: Package binaries with dependencies
        id: package
        shell: pwsh
        run: |
          $stageRoot = Join-Path $pwd "dist"
          $stageDir = Join-Path $stageRoot "YTPlayer"
          if (Test-Path $stageRoot) { Remove-Item $stageRoot -Recurse -Force }
          New-Item -ItemType Directory -Path $stageDir -Force | Out-Null

          $releaseCandidates = @(
              "bin\Release",
              "bin\AnyCPU\Release",
              "bin\x64\Release"
          ) | ForEach-Object { Join-Path $pwd $_ }

          $buildOutput = $releaseCandidates | Where-Object { Test-Path $_ } | Select-Object -First 1

          if (-not $buildOutput) {
              throw "找不到 Release 编译输出目录 (bin\\Release)。请检查 MSBuild 输出。"
          }

          Write-Host "Packaging binaries from $buildOutput"
          Copy-Item -Path (Join-Path $buildOutput '*') -Destination $stageDir -Recurse -Force

          $zipName = "YTPlayer-${{ steps.version.outputs.version }}.zip"
          $zipPath = Join-Path $pwd $zipName
          if (Test-Path $zipPath) { Remove-Item $zipPath -Force }
          Compress-Archive -Path (Join-Path $stageDir '*') -DestinationPath $zipPath -Force

          $zipRelativePath = "./$zipName"

          "zip_path=$zipRelativePath" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          target_commitish: ${{ github.sha }}
          name: ${{ steps.changelog.outputs.release_name }}
          body: ${{ steps.changelog.outputs.body }}
          files: ${{ steps.package.outputs.zip_path }}
          draft: false
          prerelease: false
          generate_release_notes: false
